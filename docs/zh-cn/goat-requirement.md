# GOAT - Golang应用灰度追踪工具

## 1. 项目概述

### 1.1 背景

在对软件应用进行灰度发布（如红蓝部署、金丝雀发布）过程中，开发和运维人员通常依赖外部指标（如报错率、业务指标、资源消耗等）来决定是否推进灰度流程。然而，从第一性原理考虑，稳健的决策依据应当是由内而外的：确保灰度过程中，所有增量功能都被覆盖测试，且外部指标保持在预期范围内。

GOAT (Golang Application Tracing) 项目旨在通过自动化埋点方式，提供可靠的内部依据，帮助开发人员评估灰度发布的覆盖情况，从而做出更加安全、可靠的灰度推进决策。

### 1.2 项目目标

- 开发一个自动化埋点工具（命令行工具），为Go语言项目提供增量代码执行追踪能力
- 提供简单易用的API，便于应用程序集成埋点功能
- 通过内嵌HTTP服务，实时展示埋点覆盖状态
- 支持开发人员自定义埋点策略
- 最小化埋点代码对应用性能的影响

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 有效增量代码的识别

**有效增量代码**定义为：本次发布相对于稳定版本的、可以被执行的函数体或方法体内部的新增或修改代码。

以下内容**不**属于有效增量代码：
- 被删除的代码
- 非 *.go 文件的增量代码
- 测试文件（*_test.go）中的增量代码
- 新增的注释、空行
- 行尾新增的注释（代码本身未变）
- 函数/方法体外部的增量代码（如全局常量、变量、类型、接口和函数声明等）
- 函数/方法内部的类型声明
- 移动的文件或者重命名的文件

#### 2.1.2 逻辑分支的识别与埋点

GOAT将识别并对以下类型的逻辑分支进行埋点：

**显式分支**：
- if-else 分支
- switch-case 分支
- select-case 分支

**隐式分支**：
- 函数体中连续的非分支语句块

#### 2.1.3 埋点规则

- **前置埋点原则**：在分支代码块的开始处插入埋点代码
- **单次埋点原则**：每个逻辑分支只进行一次埋点
- **条件变更特殊处理**：当分支条件（如if条件表达式）发生变更时，需对其影响的所有一级分支额外插入埋点
- **空分支处理**：空select{}或空switch{}视为普通语句，使用前置埋点

#### 2.1.4 埋点覆盖状态追踪

- 通过内嵌HTTP服务提供埋点状态查询接口
- 支持按组件、文件、函数等维度聚合埋点覆盖状态
- 支持埋点覆盖率统计

### 2.2 命令行工具

#### 2.2.1 工具名称

```
goat
```